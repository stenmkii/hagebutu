<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Formula Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <style>
        .latex-display {
            min-height: 100px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            background: #f8fafc;
            border-radius: 0.5rem;
            margin: 1rem 0;
            border: 2px dashed #cbd5e1;
            padding: 10px;
        }
        .fraction-input-active {
            border: 2px solid #3b82f6 !important;
            background: #eff6ff !important;
            color: #1d4ed8 !important;
        }
        .option-btn {
            transition: all 0.2s;
            touch-action: manipulation;
            min-width: 3rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .option-btn:active {
            transform: scale(0.95);
        }
    </style>
</head>
<body class="bg-slate-100 min-h-screen font-sans text-slate-800">

    <div class="max-w-2xl mx-auto px-4 py-8">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-slate-900">ç‰©ç†å…¬å¼ãƒ‘ã‚ºãƒ«</h1>
            <p class="text-slate-600">è¨˜å·ã‚’æ­£ã—ãçµ„ã¿åˆã‚ã›ã¦å…¬å¼ã‚’å®Œæˆã•ã›ã¦ãã ã•ã„</p>
        </header>

        <!-- Quiz Container -->
        <main id="quiz-container" class="bg-white rounded-xl shadow-lg p-6 mb-6 hidden">
            <div class="flex justify-between items-center mb-4">
                <span id="quiz-category" class="bg-blue-100 text-blue-800 text-xs font-semibold px-2.5 py-0.5 rounded">åŠ›å­¦ãƒ»é›»ç£æ°—ãƒ»åŸå­</span>
                <span id="quiz-progress" class="text-sm font-medium text-slate-500">1 / 10</span>
            </div>
            
            <h2 id="quiz-title" class="text-xl font-bold mb-2"></h2>
            <p id="quiz-description" class="text-slate-600 text-sm mb-4"></p>

            <!-- Input Area -->
            <div class="mb-6">
                <div class="flex justify-between items-end mb-2">
                    <span class="text-xs font-bold uppercase text-slate-400">ä½œæˆä¸­ã®å¼</span>
                    <button id="btn-clear" class="text-xs text-red-500 hover:text-red-700 font-bold underline">ã‚„ã‚Šç›´ã™</button>
                </div>
                <div id="current-formula-display" class="latex-display">
                    \( \)
                </div>
            </div>

            <!-- Controls -->
            <div class="grid grid-cols-2 gap-4 mb-6">
                <button id="btn-fraction" class="bg-slate-800 text-white py-3 rounded-lg font-bold hover:bg-slate-700">
                    åˆ†æ•°å…¥åŠ›ãƒ‘ãƒãƒ«ã‚’é–‹ã
                </button>
                <div id="fraction-controls" class="hidden grid grid-cols-2 gap-2">
                    <button id="btn-num" class="bg-blue-100 text-blue-600 py-1 border-2 border-transparent rounded-md text-sm font-bold">åˆ†å­ã¸å…¥åŠ›</button>
                    <button id="btn-den" class="bg-blue-100 text-blue-600 py-1 border-2 border-transparent rounded-md text-sm font-bold">åˆ†æ¯ã¸å…¥åŠ›</button>
                </div>
                <button id="btn-submit" class="bg-green-600 text-white py-3 rounded-lg font-bold hover:bg-green-500">
                    ã“ã‚Œã§åˆ¤å®šï¼
                </button>
            </div>

            <!-- Options -->
            <div class="border-t pt-4">
                <p class="text-xs font-bold uppercase text-slate-400 mb-3">è¨˜å·ã‚’é¸æŠ</p>
                <div id="options-grid" class="flex flex-wrap gap-2">
                    <!-- Buttons will be injected here -->
                </div>
            </div>
        </main>

        <!-- Loading / Message State -->
        <div id="status-message" class="text-center p-12 bg-white rounded-xl shadow-md">
            <p class="text-lg">å•é¡Œã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

        <!-- Result Modal -->
        <div id="modal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center px-4 z-50">
            <div class="bg-white rounded-xl p-8 max-w-sm w-full text-center">
                <div id="modal-icon" class="text-5xl mb-4"></div>
                <h3 id="modal-title" class="text-2xl font-bold mb-2"></h3>
                <p id="modal-body" class="text-slate-600 mb-6"></p>
                <div id="modal-correct-ans" class="mb-4 text-sm bg-slate-50 p-2 rounded hidden"></div>
                <button id="btn-next" class="w-full bg-slate-900 text-white py-3 rounded-lg font-bold">æ¬¡ã¸é€²ã‚€</button>
            </div>
        </div>
    </div>

    <script>
        let quizzes = [];
        let currentIndex = 0;
        let userInput = []; 
        
        let isFractionMode = false;
        let fractionTarget = 'num'; 
        let currentNumerator = [];
        let currentDenominator = [];

        const elements = {
            container: document.getElementById('quiz-container'),
            status: document.getElementById('status-message'),
            title: document.getElementById('quiz-title'),
            desc: document.getElementById('quiz-description'),
            progress: document.getElementById('quiz-progress'),
            display: document.getElementById('current-formula-display'),
            optionsGrid: document.getElementById('options-grid'),
            btnFraction: document.getElementById('btn-fraction'),
            fractionControls: document.getElementById('fraction-controls'),
            btnNum: document.getElementById('btn-num'),
            btnDen: document.getElementById('btn-den'),
            btnSubmit: document.getElementById('btn-submit'),
            btnClear: document.getElementById('btn-clear'),
            modal: document.getElementById('modal'),
            modalIcon: document.getElementById('modal-icon'),
            modalTitle: document.getElementById('modal-title'),
            modalBody: document.getElementById('modal-body'),
            modalAns: document.getElementById('modal-correct-ans'),
            btnNext: document.getElementById('btn-next')
        };

        // --- Data Loading ---
        async function loadQuizzes() {
            try {
                const response = await fetch('physics_quiz.json');
                const data = await response.json();
                quizzes = data.quizzes;
                initQuiz();
            } catch (error) {
                elements.status.innerHTML = `<p class="text-red-500">JSONãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç¢ºèªã—ã¦ãã ã•ã„ã€‚</p>`;
            }
        }

        // --- UI Logic ---
        function initQuiz() {
            if (currentIndex >= quizzes.length) {
                showFinalResults();
                return;
            }

            const quiz = quizzes[currentIndex];
            elements.status.classList.add('hidden');
            elements.container.classList.remove('hidden');
            
            elements.title.textContent = quiz.title;
            elements.desc.textContent = quiz.description;
            elements.progress.textContent = `${currentIndex + 1} / ${quizzes.length}`;
            
            resetInput();
            renderOptions(quiz.options);
        }

        function renderOptions(options) {
            elements.optionsGrid.innerHTML = '';
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.className = 'option-btn bg-white border border-slate-300 hover:bg-slate-50 px-3 py-2 rounded-md';
                // é¸æŠè‚¢ã‚‚LaTeXã¨ã—ã¦è¡¨ç¤º
                btn.innerHTML = `\\(${opt}\\)`;
                btn.onclick = () => addSymbol(opt);
                elements.optionsGrid.appendChild(btn);
            });
            // é¸æŠè‚¢ãƒœã‚¿ãƒ³ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°ã‚’ä¾é ¼
            if (window.MathJax) {
                MathJax.typesetPromise([elements.optionsGrid]);
            }
        }

        function addSymbol(symbol) {
            if (isFractionMode) {
                if (fractionTarget === 'num') {
                    currentNumerator.push(symbol);
                } else {
                    currentDenominator.push(symbol);
                }
            } else {
                userInput.push(symbol);
            }
            updateDisplay();
        }

        function updateDisplay() {
            let latex = buildLatexString(userInput, currentNumerator, currentDenominator, isFractionMode, fractionTarget);
            elements.display.innerHTML = `\\( ${latex} \\)`;
            
            if (window.MathJax) {
                MathJax.typesetPromise([elements.display]);
            }
        }

        function buildLatexString(base, num, den, fracMode, target) {
            let str = base.join('');
            if (fracMode) {
                let nStr = num.length > 0 ? num.join('') : (target === 'num' ? '\\color{blue}{\\square}' : '\\square');
                let dStr = den.length > 0 ? den.join('') : (target === 'den' ? '\\color{blue}{\\square}' : '\\square');
                str += ` \\frac{${nStr}}{${dStr}} `;
            }
            return str;
        }

        function resetInput() {
            userInput = [];
            closeFractionMode();
            updateDisplay();
        }

        function closeFractionMode() {
            isFractionMode = false;
            currentNumerator = [];
            currentDenominator = [];
            elements.fractionControls.classList.add('hidden');
            elements.btnFraction.classList.remove('hidden');
            elements.btnNum.classList.remove('fraction-input-active');
            elements.btnDen.classList.remove('fraction-input-active');
        }

        // --- Handlers ---
        elements.btnFraction.onclick = () => {
            isFractionMode = true;
            fractionTarget = 'num';
            elements.btnFraction.classList.add('hidden');
            elements.fractionControls.classList.remove('hidden');
            elements.btnNum.classList.add('fraction-input-active');
            updateDisplay();
        };

        elements.btnNum.onclick = () => {
            fractionTarget = 'num';
            elements.btnNum.classList.add('fraction-input-active');
            elements.btnDen.classList.remove('fraction-input-active');
            updateDisplay();
        };

        elements.btnDen.onclick = () => {
            fractionTarget = 'den';
            elements.btnDen.classList.add('fraction-input-active');
            elements.btnNum.classList.remove('fraction-input-active');
            updateDisplay();
        };

        elements.btnClear.onclick = resetInput;

        elements.btnSubmit.onclick = () => {
            // å…¥åŠ›å¼ã‚’åˆæˆ
            let finalFormula = userInput.join('');
            if (currentNumerator.length > 0 || currentDenominator.length > 0) {
                finalFormula += `\\frac{${currentNumerator.join('')}}{${currentDenominator.join('')}}`;
            }
            
            checkAnswer(finalFormula);
        };

        function checkAnswer(userLatex) {
            const quiz = quizzes[currentIndex];
            
            // æ­£è¦åŒ–é–¢æ•°ï¼šã‚¹ãƒšãƒ¼ã‚¹ã€ä¸­æ‹¬å¼§ã€ãƒãƒƒã‚¯ã‚¹ãƒ©ãƒƒã‚·ãƒ¥ã®é‡è¤‡ãªã©ã‚’é™¤å»
            const normalize = (s) => s.replace(/\s/g, '').replace(/\{/g, '').replace(/\}/g, '').replace(/\\/g, '');

            // ç­‰å·ã§åˆ†å‰²ã—ã¦å·¦è¾ºã¨å³è¾ºã‚’å–å¾—
            const userParts = userLatex.split('=');
            const answerParts = quiz.answer.split('=');

            let isCorrect = false;

            if (userParts.length === 2 && answerParts.length === 2) {
                const u1 = normalize(userParts[0]);
                const u2 = normalize(userParts[1]);
                const a1 = normalize(answerParts[0]);
                const a2 = normalize(answerParts[1]);

                // é †ç•ªãŒä¸€è‡´ã—ã¦ã„ã‚‹ã€ã¾ãŸã¯å·¦å³ãŒå…¥ã‚Œæ›¿ã‚ã£ã¦ã„ã‚‹
                if ((u1 === a1 && u2 === a2) || (u1 === a2 && u2 === a1)) {
                    isCorrect = true;
                }
            } else {
                // ç­‰å·ãŒãªã„å ´åˆãªã©ã¯å˜ç´”æ¯”è¼ƒ
                if (normalize(userLatex) === normalize(quiz.answer)) {
                    isCorrect = true;
                }
            }

            showModal(isCorrect);
        }

        function showModal(isCorrect) {
            elements.modalIcon.textContent = isCorrect ? 'ğŸ‰' : 'ğŸ¤”';
            elements.modalTitle.textContent = isCorrect ? 'æ­£è§£ã§ã™ï¼' : 'æƒœã—ã„ï¼';
            elements.modalBody.textContent = isCorrect 
                ? 'å®Œç’§ã«çµ„ã¿ç«‹ã¦ã‚‰ã‚Œã¾ã—ãŸã€‚' 
                : 'ã‚‚ã†ä¸€åº¦å…¬å¼ã‚’ç¢ºèªã—ã¦ã¿ã¾ã—ã‚‡ã†ã€‚';
            
            elements.modalAns.classList.remove('hidden');
            elements.modalAns.innerHTML = `æ­£è§£ä¾‹: \\(${quizzes[currentIndex].answer}\\)`;
            
            elements.modal.classList.remove('hidden');
            if (window.MathJax) {
                MathJax.typesetPromise([elements.modalAns]);
            }
        }

        elements.btnNext.onclick = () => {
            elements.modal.classList.add('hidden');
            currentIndex++;
            initQuiz();
        };

        function showFinalResults() {
            elements.container.innerHTML = `
                <div class="text-center py-8">
                    <h2 class="text-3xl font-bold mb-4">å…¨å•ã‚¯ãƒªã‚¢ï¼</h2>
                    <p class="mb-6 text-slate-600">ç‰©ç†å…¬å¼ã®å½¢ã‚’ã—ã£ã‹ã‚Šè¦šãˆã‚‰ã‚Œã¾ã—ãŸã­ã€‚</p>
                    <button onclick="location.reload()" class="bg-blue-600 text-white px-8 py-3 rounded-lg font-bold">
                        ã‚‚ã†ä¸€åº¦æŒ‘æˆ¦
                    </button>
                </div>
            `;
        }

        window.onload = loadQuizzes;
    </script>
</body>
</html>
